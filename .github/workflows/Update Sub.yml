name: Update VLESS Proxies

on:
  schedule:
    - cron: '0 0 * * *' # 每天UTC 00:00运行
  workflow_dispatch:

jobs:
  update-proxies:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: 3.11

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyyaml requests

      - name: Fetch subscription and update YAML
        run: |
          python << 'EOF'
          import re
          import requests
          import yaml
          
          # 1. 获取订阅
          sub_url = "https://cfxr.eu.org/getSub"
          r = requests.get(sub_url)
          r.raise_for_status()
          content = r.text
          
          # 2. 正则提取 VLESS 节点
          vless_pattern = re.compile(
              r"vless://(?P<uuid>[0-9a-fA-F-]+)@(?P<server>[^:]+):(?P<port>\d+)"
              r"\?encryption=[^&]+"
              r"(?:&security=(?P<security>[^&]+))?"
              r"&sni=(?P<sni>[^&]+)"
              r"&type=(?P<type>[^&]+)"
              r"&host=(?P<host>[^&]+)"
              r"&path=(?P<path>[^#]+)"
              r"#(?P<name>[^ ]+)"
          )
          nodes = []
          for match in vless_pattern.finditer(content):
              node = match.groupdict()
              nodes.append({
                  "name": f"🌐全球智能路由 - {node['name']}",
                  "server": node["server"],
                  "port": int(node["port"]),
                  "client-fingerprint": "chrome",
                  "type": node["type"],
                  "uuid": node["uuid"],
                  "tls": True if node.get("security","").lower() == "tls" else False,
                  "tfo": False,
                  "skip-cert-verify": False,
                  "servername": node["sni"],
                  "network": node["type"],
                  "ws-opts": {
                      "path": requests.utils.unquote(node["path"]),
                      "headers": {"Host": node["host"]}
                  }
              })
          
          # 3. 获取 sayuri.yaml
          yaml_url = "https://raw.githubusercontent.com/godlikeanyone/Stash/refs/heads/main/sayuri.yaml"
          r2 = requests.get(yaml_url)
          r2.raise_for_status()
          data = yaml.safe_load(r2.text)
          
          # 4. 更新 proxies
          data['proxies'] = nodes
          
          # 5. 写入文档
          with open("sayuri.yaml", "w", encoding="utf-8") as f:
              yaml.safe_dump(data, f, allow_unicode=True)


          EOF
          
      - name: Commit and push
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add sayuri.yaml
          git commit -m "Update VLESS proxies from subscription" || echo "No changes to commit"
          git push
