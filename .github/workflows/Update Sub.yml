name: Update VLESS Proxies

on:
  schedule:
    - cron: '5 0 * * *'
  workflow_dispatch:

jobs:
  update-proxies:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: 3.11

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests

      - name: Fetch subscription and update YAML
        run: |
          python << 'EOF'
          import re
          import requests
          
          # 1. èŽ·å–è®¢é˜…æ–‡æœ¬
          sub_url = "https://cfxr.eu.org/getSub"
          sub_response = requests.get(sub_url)
          sub_response.raise_for_status()
          sub_text = sub_response.text
          
          # 2. æå– vless://uuid ä¸­çš„ UUID
          uuid_match = re.search(r'vless://([0-9a-fA-F\-]{36})@', sub_text)
          if not uuid_match:
              raise ValueError("æ²¡æœ‰æ‰¾åˆ° vless UUID")
          new_uuid = uuid_match.group(1)
          print(f"æå–åˆ°çš„ UUID: {new_uuid}")
          
          # 3. æ‹‰å– YAML æ–‡ä»¶
          yaml_url = "https://github.com/godlikeanyone/Stash/raw/refs/heads/main/sayuri.yaml"
          yaml_response = requests.get(yaml_url)
          yaml_response.raise_for_status()
          yaml_text = yaml_response.text
          
          # 4. ä¸¥æ ¼åŒ¹é… Snippets å’Œ Snippets2 è¡Œï¼Œå¹¶æ›¿æ¢ uuid
          pattern = re.compile(
              r'(- \{name: ðŸŒå…¨çƒæ™ºèƒ½è·¯ç”± - Snippets2?,[^}]*uuid: )([0-9a-fA-F\-]{36})(,.*\})'
          )
          
          def replacer(match):
              return f"{match.group(1)}{new_uuid}{match.group(3)}"
          
          yaml_modified = pattern.sub(replacer, yaml_text)
          
          # 5. ä¿å­˜ä¿®æ”¹åŽçš„ YAML
          with open("sayuri.yaml", "w", encoding="utf-8") as f:
              f.write(yaml_modified)

          EOF
          
      - name: Commit and push
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add sayuri.yaml
          git commit -m "Update VLESS proxies from subscription" || echo "No changes to commit"
          git push
