name: Update Sub

on:
  workflow_dispatch:
  schedule:
    - cron: "0 */6 * * *" # æ¯6å°æ—¶è¿è¡Œä¸€æ¬¡

jobs:
  update:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.x"

      - name: Install dependencies
        run: pip install requests

      - name: Fetch and update sayuri.yaml
        run: |
          python <<'EOF'
          import requests, re

          # æ‹‰å– sayuri.yaml åŸæ–‡
          base_url = "https://raw.githubusercontent.com/godlikeanyone/Stash/refs/heads/main/sayuri.yaml"
          base_text = requests.get(base_url, timeout=10).text

          # è·å–è®¢é˜…
          sub_url = "https://cfxr.eu.org/getSub"
          subs = requests.get(sub_url, timeout=10).text.strip().splitlines()

          # æå–å‰ä¸¤ä¸ª vless èŠ‚ç‚¹
          vless = [s for s in subs if s.startswith("vless://")]
          if not vless:
              raise SystemExit("è®¢é˜…é‡Œæ²¡æœ‰ vless èŠ‚ç‚¹ï¼")
          elif len(vless) == 1:
              vless = [vless[0], vless[0]]
          else:
              vless = vless[:2]

          def vless_to_inline(name, link):
              m = re.match(r"vless://([^@]+)@([^:]+):(\d+)\?(.+)#(.+)", link)
              if not m: 
                  return ""
              uuid, server, port, params, _ = m.groups()
              opts = dict([p.split("=",1) for p in params.split("&") if "=" in p])
              line = f'- {{name: {name}, server: {server}, port: {port}, client-fingerprint: chrome, type: vless, uuid: {uuid}, tls: {str(opts.get("security")=="tls").lower()}, tfo: false, skip-cert-verify: false'
              if opts.get("type") == "ws":
                  host = opts.get("host", server)
                  path = opts.get("path", "/")
                  line += f', network: ws, ws-opts: {{path: "{path}", headers: {{Host: {host}}}}}}}'
              else:
                  line += "}"
              return line

          snip1 = vless_to_inline("ğŸŒå…¨çƒæ™ºèƒ½è·¯ç”± - Snippets", vless[0])
          snip2 = vless_to_inline("ğŸŒå…¨çƒæ™ºèƒ½è·¯ç”± - Snippets2", vless[1])

          # æ›¿æ¢åŸå§‹æ–‡æœ¬é‡Œçš„èŠ‚ç‚¹è¡Œ
          base_text = re.sub(r"- \{name: ğŸŒå…¨çƒæ™ºèƒ½è·¯ç”± - Snippets[^\n]*", snip1, base_text)
          base_text = re.sub(r"- \{name: ğŸŒå…¨çƒæ™ºèƒ½è·¯ç”± - Snippets2[^\n]*", snip2, base_text)

          # å†™å›æ–‡ä»¶
          with open("sayuri.yaml", "w", encoding="utf-8") as f:
              f.write(base_text)

          EOF

      - name: Commit changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add sayuri.yaml
          git commit -m "Replace Snippets nodes with latest vless" || echo "No changes"
          git push
