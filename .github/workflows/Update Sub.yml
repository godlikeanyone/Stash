import re
import requests

# 1. è·å–è®¢é˜…
sub_url = "https://cfxr.eu.org/getSub"
r = requests.get(sub_url)
r.raise_for_status()
content = r.text

# 2. åŒ¹é… registry.cyou ä¸Šçš„ vless èŠ‚ç‚¹
vless_pattern = re.compile(
    r"vless://(?P<uuid>[0-9a-fA-F-]+)@registry\.cyou:443"
    r"\?encryption=[^&]+"
    r"(?:&security=(?P<security>[^&]+))?"
    r"&sni=(?P<sni>[^&]+)"
    r"&type=ws"
    r"&host=(?P<host>[^&]+)"
    r"&path=(?P<path>[^#]+)"
)
matches = list(vless_pattern.finditer(content))

# 3. å›ºå®šæ¨¡æ¿ name
names = ["ğŸŒå…¨çƒæ™ºèƒ½è·¯ç”± - Snippets", "ğŸŒå…¨çƒæ™ºèƒ½è·¯ç”± - Snippets2"]

# 4. æ„å»º proxies æ–‡æœ¬
nodes_text = ""
if len(matches) >= 2:
    selected = matches[:2]
elif len(matches) == 1:
    selected = [matches[0], matches[0]]  # ç”¨åŒä¸€ä¸ªèŠ‚ç‚¹æ›¿æ¢ä¸¤ä¸ª
else:
    selected = []  # æ²¡æœ‰èŠ‚ç‚¹å°±æ¸…ç©º proxies

for i, match in enumerate(selected):
    node = match.groupdict()
    nodes_text += f"""  - {{name: {names[i]}, server: registry.cyou, port: 443, client-fingerprint: chrome, type: vless, uuid: {node['uuid']}, tls: {str(node.get('security','').lower()=='tls').lower()}, tfo: false, skip-cert-verify: false, servername: {node['sni']}, network: ws, ws-opts: {{path: "{requests.utils.unquote(node['path'])}", headers: {{Host: {node['host']}}}}}}}\n"""

# 5. è·å– sayuri.yaml
yaml_url = "https://raw.githubusercontent.com/godlikeanyone/Stash/refs/heads/main/sayuri.yaml"
r2 = requests.get(yaml_url)
r2.raise_for_status()
yaml_text = r2.text

# 6. æ›¿æ¢ proxies åŒºå—
yaml_text_new = re.sub(
    r"(proxies:\s*\n)(?:[^\n]*\n)*(?=(?:\w+:|$))",
    r"\1" + nodes_text,
    yaml_text,
    flags=re.MULTILINE
)

# 7. å†™å›æ–‡æ¡£
with open("sayuri.yaml", "w", encoding="utf-8") as f:
    f.write(yaml_text_new)
