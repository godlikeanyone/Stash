import re
import requests

# 1. 获取订阅
sub_url = "https://cfxr.eu.org/getSub"
r = requests.get(sub_url)
r.raise_for_status()
content = r.text

# 2. 匹配 registry.cyou 上的 vless 节点
vless_pattern = re.compile(
    r"vless://(?P<uuid>[0-9a-fA-F-]+)@registry\.cyou:443"
    r"\?encryption=[^&]+"
    r"(?:&security=(?P<security>[^&]+))?"
    r"&sni=(?P<sni>[^&]+)"
    r"&type=ws"
    r"&host=(?P<host>[^&]+)"
    r"&path=(?P<path>[^#]+)"
)
matches = list(vless_pattern.finditer(content))

# 3. 固定模板 name
names = ["🌐全球智能路由 - Snippets", "🌐全球智能路由 - Snippets2"]

# 4. 构建 proxies 文本
nodes_text = ""
if len(matches) >= 2:
    selected = matches[:2]
elif len(matches) == 1:
    selected = [matches[0], matches[0]]  # 用同一个节点替换两个
else:
    selected = []  # 没有节点就清空 proxies

for i, match in enumerate(selected):
    node = match.groupdict()
    nodes_text += f"""  - {{name: {names[i]}, server: registry.cyou, port: 443, client-fingerprint: chrome, type: vless, uuid: {node['uuid']}, tls: {str(node.get('security','').lower()=='tls').lower()}, tfo: false, skip-cert-verify: false, servername: {node['sni']}, network: ws, ws-opts: {{path: "{requests.utils.unquote(node['path'])}", headers: {{Host: {node['host']}}}}}}}\n"""

# 5. 获取 sayuri.yaml
yaml_url = "https://raw.githubusercontent.com/godlikeanyone/Stash/refs/heads/main/sayuri.yaml"
r2 = requests.get(yaml_url)
r2.raise_for_status()
yaml_text = r2.text

# 6. 替换 proxies 区块
yaml_text_new = re.sub(
    r"(proxies:\s*\n)(?:[^\n]*\n)*(?=(?:\w+:|$))",
    r"\1" + nodes_text,
    yaml_text,
    flags=re.MULTILINE
)

# 7. 写回文档
with open("sayuri.yaml", "w", encoding="utf-8") as f:
    f.write(yaml_text_new)
