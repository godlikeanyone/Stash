name: Update VLESS Proxies

on:
  schedule:
    - cron: '5 0 * * *'
  workflow_dispatch:

jobs:
  update-proxies:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: 3.11

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyyaml requests

      - name: Fetch subscription and update YAML
        run: |
          python << 'EOF'
          import re
          import requests
          
          # 获取订阅
          sub_url = "https://cfxr.eu.org/getSub"
          r = requests.get(sub_url)
          r.raise_for_status()
          content = r.text
          
          # 匹配 registry.cyou 上的 vless 节点
          vless_pattern = re.compile(
              r"vless://(?P<uuid>[0-9a-fA-F-]+)@(?P<server>[^:]+):443"
              r"\?encryption=[^&]+"
              r"(?:&security=[^&]+)?"
              r"&sni=(?P<sni>[^&]+)"
              r"&type=ws"
              r"&host=(?P<host>[^&]+)"
              r"&path=(?P<path>[^#]+)"
          )
          matches = list(vless_pattern.finditer(content))
          
          # 取前两条节点，单节点重复
          if len(matches) >= 2:
              selected = matches[:2]
          elif len(matches) == 1:
              selected = [matches[0], matches[0]]
          else:
              selected = []
          
          # 读取 sayuri.yaml
          yaml_url = "https://raw.githubusercontent.com/godlikeanyone/Stash/refs/heads/main/sayuri.yaml"
          r2 = requests.get(yaml_url)
          r2.raise_for_status()
          yaml_text = r2.text
          
          # 替换 Snippets / Snippets2
          lines = yaml_text.splitlines()
          new_lines = []
          snippets_index = 0
          
          for line in lines:
              if line.startswith("- {name: 🌐全球智能路由 - Snippets") and snippets_index < len(selected):
                  node = selected[snippets_index].groupdict()
                  line = re.sub(r'uuid:\s*[0-9a-fA-F-]+', f"uuid: {node['uuid']}", line)
                  line = re.sub(r'servername:\s*[^,}]+', f"servername: {node['sni']}", line)
                  line = re.sub(r'server:\s*[^,}]+', f"server: {node['server']}", line)
                  line = re.sub(r'path:\s*".*?"', f'path: "{requests.utils.unquote(node["path"])}"', line)
                  line = re.sub(r'Host:\s*[^}]+', f'Host: {node["host"]}', line)
                  snippets_index += 1
              elif line.startswith("- {name: 🌐全球智能路由 - Snippets2") and snippets_index < len(selected):
                  node = selected[snippets_index].groupdict()
                  line = re.sub(r'uuid:\s*[0-9a-fA-F-]+', f"uuid: {node['uuid']}", line)
                  line = re.sub(r'servername:\s*[^,}]+', f"servername: {node['sni']}", line)
                  line = re.sub(r'server:\s*[^,}]+', f"server: {node['server']}", line)
                  line = re.sub(r'path:\s*".*?"', f'path: "{requests.utils.unquote(node["path"])}"', line)
                  line = re.sub(r'Host:\s*[^}]+', f'Host: {node["host"]}', line)
                  snippets_index += 1
              new_lines.append(line)
          
          yaml_text_new = "\n".join(new_lines) + "\n"
          
          # 写回文档
          with open("sayuri.yaml", "w", encoding="utf-8") as f:
              f.write(yaml_text_new)

          EOF
          
      - name: Commit and push
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add sayuri.yaml
          git commit -m "Update VLESS proxies from subscription" || echo "No changes to commit"
          git push
